---
import Layout from "../../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { resolvePath, detectLocale, buildLocalizedPath } from "../../../utils/paths";

export async function getStaticPaths() {
  const members = await getCollection("members");
  const faculty = members.find((m) => m.id === "faculty");

  if (!faculty) return [];

  const locales = ['ja', 'en'] as const;
  return locales.flatMap((locale) =>
    faculty.data.items
      .filter((m) => m.id)
      .map((member) => ({
        params: { locale, id: member.id },
        props: { member },
      }))
  );
}

const { member } = Astro.props;
const locale = detectLocale(Astro.url.pathname);

// Get localized values
const displayName = locale === "en" ? (member.nameEn ?? member.name) : member.name;
const displayRole = locale === "en" ? (member.roleEn ?? member.role) : member.role;
const displayDescription = locale === "en" ? (member.descriptionEn ?? member.description) : member.description;
const displayLocation = locale === "en" ? (member.locationEn ?? member.location) : member.location;
const displayResearchAreas = locale === "en" ? (member.researchAreasEn ?? member.researchAreas) : member.researchAreas;
const displayCourses = locale === "en" ? (member.coursesEn ?? member.courses) : member.courses;

const copy = {
  ja: {
    metaTitle: `${member.name} | 坂田・森・浅谷・西本研究室`,
    back: "← 戻る",
    labels: {
      location: "居室",
      researchAreas: "研究分野",
      courses: "担当講義",
    },
  },
  en: {
    metaTitle: `${displayName} | Sakata / Mori / Asatani / Nishimoto Lab`,
    back: "← Back",
    labels: {
      location: "Office",
      researchAreas: "Research Areas",
      courses: "Courses",
    },
  },
} as const;

const t = copy[locale];
const listPath = buildLocalizedPath(locale, "members");
---

<Layout title={t.metaTitle}>
  <main>
    <div class="member-profile">
      <div class="profile-header">
        <div class="avatar-large">
          {
            member.image ? (
              <img
                src={resolvePath(member.image)}
                alt={displayName}
                class="profile-image"
                loading="lazy"
                decoding="async"
              />
            ) : (
              member.avatar
            )
          }
        </div>
        <div class="profile-info">
          <h1>{displayName}</h1>
          {displayRole && (
            <p class="role">{displayRole}</p>
          )}
        </div>
      </div>

      <div class="profile-content">
        {displayDescription && <p class="description">{displayDescription}</p>}

        <div class="info-grid">
          {
            displayLocation && (
              <div class="info-item">
                <h3>{t.labels.location}</h3>
                <p>{displayLocation}</p>
              </div>
            )
          }
          {
            displayResearchAreas && (
              <div class="info-item">
                <h3>{t.labels.researchAreas}</h3>
                <p>{displayResearchAreas}</p>
              </div>
            )
          }
          {
            displayCourses && (
              <div class="info-item">
                <h3>{t.labels.courses}</h3>
                <p>{displayCourses}</p>
              </div>
            )
          }
        </div>

        <button type="button" class="back-link" onclick="history.back()">{t.back}</button>
      </div>
    </div>
  </main>
</Layout>

<style>
  main {
    max-width: 800px;
    margin: 0 auto;
    padding: 8rem 5rem 4rem;
    min-height: 80vh;
  }

  .member-profile {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 3rem;
    box-shadow: var(--shadow);
  }

  .profile-header {
    display: flex;
    align-items: center;
    gap: 2rem;
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--border);
  }

  .avatar-large {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    color: var(--accent);
    font-weight: 500;
    overflow: hidden;
  }

  .profile-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .profile-info h1 {
    font-size: 1.8rem;
    margin-bottom: 0.5rem;
  }

  .role {
    color: var(--text-secondary);
    font-size: 1rem;
  }

  .profile-content {
    line-height: 1.8;
    color: var(--text-secondary);
  }

  .description {
    font-size: 1.1rem;
    margin-bottom: 2rem;
    color: var(--text-primary);
  }

  .info-grid {
    display: grid;
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .info-item h3 {
    font-size: 0.9rem;
    color: var(--accent);
    margin-bottom: 0.5rem;
    font-weight: 600;
  }

  .info-item p {
    color: var(--text-primary);
  }

  .back-link {
    display: inline-block;
    margin-top: 2rem;
    color: var(--accent);
    background: none;
    border: none;
    padding: 0;
    font: inherit;
    font-weight: 500;
    cursor: pointer;
  }

  .back-link:hover {
    opacity: 0.8;
  }

  @media (max-width: 600px) {
    .profile-header {
      flex-direction: column;
      text-align: center;
    }

    main {
      padding: 6rem 1.5rem 3rem;
    }

    .member-profile {
      padding: 1.5rem;
    }
  }
</style>
