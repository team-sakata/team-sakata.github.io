---
import Layout from "../../layouts/Layout.astro";
import Hero from "../../components/Hero.astro";
import BentoCard from "../../components/BentoCard.astro";
import ResearchArea from "../../components/ResearchArea.astro";
import MemberSection from "../../components/MemberSection.astro";
import NewsItem from "../../components/NewsItem.astro";
import PublicationItem from "../../components/PublicationItem.astro";
import LabGuidelines from "../../components/LabGuidelines.astro";

import {
  getSortedActivity,
  getSortedMembers,
  getResearch,
  getResearchFocus,
  getPublications,
} from "../../utils/collections";

const activity = await getSortedActivity();
const members = await getSortedMembers();
const research = await getResearch();
const researchFocus = await getResearchFocus();
const publications = await getPublications();

import news from "../../data/news.yaml";
import { resolvePath } from "../../utils/paths";

// Sort collections
research.sort((a, b) => a.data.order - b.data.order);
research.sort((a, b) => a.data.order - b.data.order);
members.sort((a, b) => a.data.order - b.data.order);
researchFocus.sort((a, b) => a.data.order - b.data.order);
// News is already in order in the hardcoded array
// Publications are already sorted in the list file
---

<Layout title="坂田・森・浅谷・西本研究室 | 東京大学">
  <Hero />

  <div class="bento-grid">
    <!-- Lab Guidelines (Full Width) -->
    <BentoCard title="研究室の指針" class="guidelines-card full-width">
      <LabGuidelines />
    </BentoCard>

    <!-- News Area (Left 2/3) -->
    <BentoCard title="ニュース" class="news-card span-2 tall-1-4">
      <div class="news-preview">
        {
          news
            .slice(0, 5)
            .map((item: { date: string; text: string; link?: string }) => (
              <div class="news-preview-item">
                <span class="date">{item.date}</span>
                {item.link ? (
                  <a
                    href={item.link}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text link"
                  >
                    {item.text}
                  </a>
                ) : (
                  <span class="text">{item.text}</span>
                )}
              </div>
            ))
        }
      </div>
      <a href={`${import.meta.env.BASE_URL}/news`} class="view-all-link"
        >すべて見る →</a
      >
    </BentoCard>

    <!-- Members Area (Right 1/3) -->
    <BentoCard title="メンバー" class="members-card span-1 tall-1-4">
      <div class="members-preview">
        {
          (() => {
            const faculty = members.find((g) => g.data.title === "教員");
            if (!faculty) return null;
            return (
              <div class="faculty-list">
                {faculty.data.items.map((member) => (
                  <div class="faculty-item">
                    <img
                      src={resolvePath(member.image || "")}
                      alt={member.name}
                      class="faculty-avatar"
                    />
                    <div class="faculty-info">
                      <span class="faculty-name">{member.name}</span>
                      <span class="faculty-role">{member.role}</span>
                      {member.description && (
                        <p class="faculty-description">{member.description}</p>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            );
          })()
        }
      </div>
      <a href={`${import.meta.env.BASE_URL}/members`} class="view-all-link"
        >すべて見る →</a
      >
    </BentoCard>

    <!-- Research (Full Width) -->
    <BentoCard
      title="研究内容"
      class="research-card full-width tall-huge"
      href={`${import.meta.env.BASE_URL}/research`}
    >
      <div class="research-preview">
        <h3>技術経営学 / 計算社会科学 / 計算言語学</h3>
        <p class="line-clamp-3">
          2009年にスタートし、開設15年になる我々の研究室では、経済・社会に関する洞察とAI・データサイエンスの手法を組み合わせることで、技術経営学の領域で新境地を切り開き、また、世界のトップチームの一つとなることを目指しています。分析手法としては、技術経営領域でもその活用が期待されている機械学習・深層学習、ネットワーク解析、自然言語処理等のデータサイエンス系の手法を中心とし、また、手法自体に関する基礎的な研究も重視しています。
        </p>
        <p class="line-clamp-3">
          そうした手法を用いた考察の対象としては、大規模な学術ビックデータ、ソーシャルメディア、取引関係やM&A等を含む大規模な企業情報、列車を利用したトリップデータ、レビュー文など、様々なものを扱っています。生成AIに関しては、逆学習を用いたLLMの解析に先駆的に取り組んでいます。
        </p>
        <p class="line-clamp-3">
          さらに、このような研究を進めるための外部連携として、「テクノロジー・インフォマティックス社会連携講座」や「事前学習言語モデルとネットワークの融合に基づく科学技術トレンド予測（NEDO/産業技術総合研究所）」の代表を務めるほか、多様な企業等と共同研究を行っています。
        </p>
      </div>
    </BentoCard>

    <!-- Research Focus & Activity Boxes (Show 3 items: 1 Activity, 2 Research) -->
    {
      (() => {
        // Select 1 activity (e.g., the one with ID 20231114_01)
        const selectedActivity = activity.find((a) => a.id === "20231114_01");

        // Select 2 research focus items (e.g., order 1 and 2)
        const selectedResearch = researchFocus.filter(
          (r) => r.data.order === 1 || r.data.order === 2,
        );

        // Combine and sort/order them as needed. Here we just put activity first, then research.
        // Or we can interleave them. Let's do Activity, Research 1, Research 2.
        const mixedItems = [];
        if (selectedActivity) {
          mixedItems.push({
            type: "activity",
            title: selectedActivity.data.title,
            description:
              selectedActivity.data.description_short ||
              selectedActivity.data.description,
            image: selectedActivity.data.image,
            link: `${import.meta.env.BASE_URL}/activity/${selectedActivity.id}`,
            tags: ["Activity"],
          });
        }

        selectedResearch.forEach((r) => {
          mixedItems.push({
            type: "research",
            title: r.data.title,
            description: r.data.description_short || r.data.description,
            image: r.data.image,
            link: `${import.meta.env.BASE_URL}/research/focus${r.data.order}`,
            tags: ["Research", "Publications"],
          });
        });

        return mixedItems.map((item) => (
          <BentoCard
            title={item.title}
            class="research-focus-card span-1 fixed-height"
            href={item.link}
          >
            <div class="focus-preview">
              {item.image && (
                <img
                  src={resolvePath(item.image)}
                  alt={item.title}
                  class="focus-image"
                />
              )}
              <p class="line-clamp-3">{item.description}</p>
              <div class="focus-tags">
                {item.tags.map((tag) => (
                  <span class="focus-tag">{tag}</span>
                ))}
              </div>
            </div>
          </BentoCard>
        ));
      })()
    }

    <!-- Publications Area -->
    <BentoCard title="論文リスト" class="publications-card full-width">
      <div class="publications-list-compact">
        {
          publications
            .filter((p) => !p.hidden)
            .slice(0, 5)
            .map((pub) => (
              <div class="pub-item-compact">
                <span class="pub-year">{pub.year}</span>
                <span class="pub-title">{pub.title}</span>
                <span class="pub-venue">{pub.venue}</span>
              </div>
            ))
        }
      </div>
      <a href={`${import.meta.env.BASE_URL}/publications`} class="view-all-link"
        >すべて見る →</a
      >
    </BentoCard>

    <!-- Join Us (Left 2/3) -->
    <BentoCard
      title="新入生の方へ"
      class="span-2"
      href={`${import.meta.env.BASE_URL}/visit`}
    >
      <p>
        研究室見学を随時受け付けています。研究会（月1回・木曜4限）や輪読会の見学を推奨しています。
      </p>
      <p
        style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted);"
      >
        どの教員に配属となっても同じ環境で指導を受けられます。
      </p>
    </BentoCard>

    <!-- Contact (Right 1/3) -->
    <BentoCard title="アクセス" id="contact" class="span-1">
      <div class="contact-info">
        <div class="contact-row">
          <svg
            class="contact-icon"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
            ></path>
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          東京大学 本郷キャンパス<br />工学部3号館 202号室
        </div>
        <div class="contact-row">
          <svg
            class="contact-icon"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
            ></path>
          </svg>
          info@ipr-ctr.t.u-tokyo.ac.jp
        </div>
      </div>
    </BentoCard>
  </div>
</Layout>

<style>
  .bento-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }

  /* Specific Card Styles */
  :global(.bento-card.full-width) {
    grid-column: 1 / -1;
  }

  :global(.bento-card.large) {
    min-height: 300px;
  }

  :global(.bento-card.wide) {
    grid-column: span 2;
    min-height: 200px;
  }

  :global(.bento-card.span-1) {
    grid-column: span 1;
  }

  :global(.bento-card.span-2) {
    grid-column: span 2;
  }

  .research-preview h3,
  .visit-preview h3 {
    font-size: 1.1rem;
    color: var(--accent);
    margin-bottom: 0.5rem;
  }

  .news-preview {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
  }

  .news-preview-item {
    display: flex;
    gap: 1rem;
    font-size: 0.9rem;
  }

  .news-preview-item .date {
    color: var(--text-muted);
    font-family: var(--font-mono);
    white-space: nowrap;
  }

  .news-preview-item .text.link {
    text-decoration: underline;
    text-decoration-color: var(--accent);
    text-underline-offset: 2px;
    color: inherit;
  }

  .news-preview-item .text.link:hover {
    color: var(--accent);
  }

  .view-all-link {
    display: inline-block;
    margin-top: 1rem;
    font-size: 0.85rem;
    color: var(--accent);
    text-decoration: none;
    font-weight: 500;
    transition: transform 0.2s ease;
  }

  .view-all-link:hover {
    transform: translateX(4px);
  }

  @media (max-width: 768px) {
    .bento-grid {
      grid-template-columns: 1fr;
    }

    :global(.bento-card.wide),
    :global(.bento-card.large) {
      grid-column: span 1;
    }
  }

  /* Keywords */
  .keywords {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-top: 0.75rem;
  }

  .keyword {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    padding: 0.25rem 0.6rem;
    border-radius: 4px;
    font-size: 0.7rem;
    color: var(--text-secondary);
  }

  /* Contact card */
  .contact-info {
    margin-top: 0.5rem;
  }

  .contact-row {
    display: flex;
    align-items: flex-start;
    gap: 0.6rem;
    margin-bottom: 0.6rem;
    font-size: 0.8rem;
    color: var(--text-secondary);
    line-height: 1.5;
  }

  .contact-icon {
    color: var(--accent-light);
    width: 14px;
    flex-shrink: 0;
    margin-top: 2px;
  }

  /* News List */
  .news-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-top: 0.5rem;
  }

  :global(.bento-card.expanded) .news-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1rem;
  }

  /* Pub List */
  .pub-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 0.5rem;
  }

  :global(.bento-card.expanded) .pub-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1rem;
  }

  /* Research Focus Links */
  .research-focus-link {
    text-decoration: none;
    color: inherit;
    display: block;
    transition: transform 0.2s ease;
  }

  .research-focus-link:hover {
    transform: translateY(-2px);
  }

  .focus-preview p,
  .activity-preview p {
    font-size: 0.9rem;
    color: var(--text-secondary);
    line-height: 1.6;
    margin-bottom: 1rem;
  }

  .focus-image {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-radius: 6px;
    margin-bottom: 1rem;
    border: 1px solid var(--border);
  }

  .focus-tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .focus-tag {
    font-size: 0.7rem;
    padding: 0.15rem 0.5rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
    color: var(--text-secondary);
  }

  .focus-full {
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @media (max-width: 900px) {
    .bento-grid {
      grid-template-columns: 1fr;
      padding: 1rem;
      gap: 1rem;
    }

    :global(.bento-card.span-2),
    :global(.bento-card.wide),
    :global(.bento-card.large),
    :global(.bento-card.full-width) {
      grid-column: span 1;
    }

    :global(.bento-card.expanded) .pub-list,
    :global(.bento-card.expanded) .news-list {
      grid-template-columns: 1fr;
    }

    .publications-preview {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 600px) {
    .bento-grid {
      padding: 0;
      gap: 0.75rem;
    }
  }

  /* Faculty Preview */
  .faculty-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .faculty-item {
    display: flex;
    align-items: center;
    gap: 0.8rem;
  }

  .faculty-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid var(--border);
  }

  .faculty-info {
    display: flex;
    flex-direction: column;
    line-height: 1.2;
  }

  .faculty-name {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-primary);
  }

  .faculty-role {
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .faculty-description {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Publications Preview */
  .publications-preview {
    display: flex;
    overflow-x: auto;
    gap: 1.5rem;
    padding-bottom: 1rem; /* Space for scrollbar */
    scrollbar-width: thin;
  }

  .publications-preview::-webkit-scrollbar {
    height: 6px;
  }

  .publications-preview::-webkit-scrollbar-thumb {
    background-color: var(--border);
    border-radius: 3px;
  }

  .pub-preview-item {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    min-width: 300px;
    flex-shrink: 0;
  }

  .pub-meta {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  .pub-year {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .pub-category {
    font-size: 0.7rem;
    padding: 0.15rem 0.5rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 3px;
    color: var(--text-secondary);
    text-transform: uppercase;
  }

  .pub-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1.4;
    margin: 0;
  }

  .pub-authors {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin: 0;
  }

  .pub-venue {
    font-size: 0.75rem;
    color: var(--text-muted);
    font-style: italic;
    margin: 0;
  }

  @media (max-width: 900px) {
    .publications-preview {
      grid-template-columns: 1fr;
    }
  }

  .publications-list-compact {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .pub-item-compact {
    display: flex;
    align-items: baseline;
    gap: 0.8rem;
    font-size: 0.9rem;
    line-height: 1.4;
    white-space: nowrap;
    overflow: hidden;
  }

  .pub-item-compact .pub-year {
    font-family: var(--font-mono);
    color: var(--accent);
    font-weight: 600;
    flex-shrink: 0;
  }

  .pub-item-compact .pub-title {
    font-weight: 500;
    color: var(--text-primary);
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .pub-item-compact .pub-venue {
    color: var(--text-muted);
    font-size: 0.8rem;
    flex-shrink: 0;
  }
</style>
